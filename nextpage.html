<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Connexion / Inscription - Mi-talky</title>
<style>
  body { font-family: Arial, sans-serif; background: #f0f2f5; margin:0; display:flex; justify-content:center; align-items:center; min-height:100vh; }
  .container { background:white; padding:30px; border-radius:12px; width:350px; box-shadow:0 4px 15px rgba(0,0,0,0.2); text-align:center; margin-bottom:20px; }
  input, button { width:100%; padding:12px; margin:8px 0; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; }
  button { background:#1877f2; color:white; border:none; cursor:pointer; }
  button:hover { background:#145dbf; }
  #resetSection, #nameContainer { display:none; margin-top:10px; }
  #walletContainer { display:none; }
</style>
</head>
<body>

<!-- Connexion / Inscription -->
<div class="container" id="authContainer">
  <h2>Connexion / Inscription</h2>
  <input type="email" id="email" placeholder="Email" required>
  <input type="password" id="password" placeholder="Mot de passe" required>
  <button onclick="signup()">S'inscrire</button>
  <button onclick="login()">Se connecter</button>
  <button onclick="toggleReset()" style="background:none;color:#1877f2;border:none;text-decoration:underline;">Mot de passe oublié ?</button>

  <div id="resetSection">
    <input type="email" id="resetEmail" placeholder="Votre email">
    <button onclick="resetPassword()">Envoyer lien de réinitialisation</button>
  </div>

  <p id="authError" style="color:red;"></p>
</div>

<!-- Nom après signup -->
<div class="container" id="nameContainer">
  <h2>Bienvenue !</h2>
  <p>Veuillez entrer votre nom complet :</p>
  <input type="text" id="fullName" placeholder="Nom complet" required>
  <button onclick="saveName()">Enregistrer et aller au Dashboard</button>
</div>

<!-- Wallet -->
<div class="container" id="walletContainer">
  <h2>Portefeuille Crypto</h2>
  <p>Utilisateur: <span id="userEmail"></span></p>
  <p>Balance: <span id="balance">0</span> BTC</p>
  <button onclick="goDashboard()">Aller au Dashboard</button>
  <button onclick="logout()">Se déconnecter</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAzcnb-eswHt_pDi7tCvcIBzlzejCprJfE",
    authDomain: "mitalky.firebaseapp.com",
    projectId: "mitalky",
    storageBucket: "mitalky.appspot.com",
    messagingSenderId: "753557195623",
    appId: "1:753557195623:web:abc3b37eca5d67c9157dc2"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const authContainer = document.getElementById('authContainer');
  const nameContainer = document.getElementById('nameContainer');
  const walletContainer = document.getElementById('walletContainer');
  const userEmailSpan = document.getElementById('userEmail');
  const authError = document.getElementById('authError');

  function signup() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    auth.createUserWithEmailAndPassword(email, password)
      .then(() => {
        authContainer.style.display = 'none';
        nameContainer.style.display = 'block'; // Afficher le form de nom
      })
      .catch(e => authError.textContent = e.message);
  }

  function saveName() {
    const fullName = document.getElementById('fullName').value;
    const user = auth.currentUser;
    if(!user) return;
    db.collection('wallets').doc(user.uid).set({ balance: 0, name: fullName })
      .then(() => {
        nameContainer.style.display = 'none';
        initWallet();
      });
  }

  function login() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    auth.signInWithEmailAndPassword(email, password)
      .then(() => initWallet())
      .catch(e => authError.textContent = e.message);
  }

  function logout() {
    auth.signOut().then(() => {
      authContainer.style.display = 'block';
      walletContainer.style.display = 'none';
    });
  }

  function toggleReset() {
    const resetSection = document.getElementById('resetSection');
    resetSection.style.display = resetSection.style.display === 'block' ? 'none' : 'block';
  }

  function resetPassword() {
    const email = document.getElementById('resetEmail').value;
    auth.sendPasswordResetEmail(email)
      .then(() => alert('Lien de réinitialisation envoyé !'))
      .catch(e => authError.textContent = e.message);
  }

  function initWallet() {
    const user = auth.currentUser;
    if(!user) return;
    userEmailSpan.textContent = user.email;
    authContainer.style.display = 'none';
    walletContainer.style.display = 'block';

    const userDoc = db.collection('wallets').doc(user.uid);
    userDoc.get().then(doc => {
      if(!doc.exists) userDoc.set({ balance:0 });
      updateBalance();
    });
  }

  function updateBalance() {
    const user = auth.currentUser;
    if(!user) return;
    db.collection('wallets').doc(user.uid).get()
      .then(doc => {
        const bal = doc.data()?.balance || 0;
        document.getElementById('balance').textContent = bal.toFixed(4);
      });
  }

  function goDashboard() {
    window.location.href = 'dashboard.html';
  }

  auth.onAuthStateChanged(user => {
    if(user) initWallet();
  });
</script>
</body>
</html>
