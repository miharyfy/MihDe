<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pub Firebase avec Like & Messages par Pub</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 700px;
    margin: 30px auto;
    background: #f0f4ff;
    padding: 20px;
    border-radius: 8px;
  }
  h2 {
    color: #1877f2;
  }
  label {
    font-weight: bold;
    display: block;
    margin-top: 15px;
  }
  input[type="text"], textarea {
    width: 100%;
    padding: 10px;
    margin-top: 5px;
    border-radius: 6px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
  button {
    margin-top: 15px;
    background: #1877f2;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
  }
  button:hover {
    background: #145dbf;
  }
  .pub {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin-top: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    position: relative;
  }
  .pub a {
    color: #1877f2;
    text-decoration: none;
  }
  .pub a:hover {
    text-decoration: underline;
  }
  .like-btn {
    background: transparent;
    border: none;
    color: #1877f2;
    font-weight: bold;
    cursor: pointer;
    margin-top: 10px;
  }
  .liked {
    color: #e0245e;
  }
  .likes-count {
    font-size: 0.9em;
    color: #555;
    margin-left: 10px;
  }
  .error {
    color: red;
    margin-top: 8px;
  }
  .messages-section {
    margin-top: 15px;
    border-top: 1px solid #ddd;
    padding-top: 15px;
  }
  .message {
    background: #e8f0fe;
    padding: 8px 12px;
    border-radius: 6px;
    margin-bottom: 8px;
  }
  .message-user {
    font-weight: bold;
    color: #1877f2;
  }
  .message-time {
    font-size: 0.8em;
    color: #555;
    margin-left: 10px;
  }
</style>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<h2>Cr√©er une Pub</h2>
<label for="pubText">Texte de la Pub :</label>
<textarea id="pubText" rows="3" placeholder="√âcrivez votre message publicitaire ici..."></textarea>

<label for="pubUrl">Lien du site (optionnel) :</label>
<input type="text" id="pubUrl" placeholder="https://exemple.com" />

<button id="btnCreatePub">Cr√©er Pub</button>
<div id="errorMsg" class="error"></div>

<h2>Liste des Pubs</h2>
<div id="pubList">Chargement...</div>

<script>
  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAzcnb-eswHt_pDi7tCvcIBzlzejCprJfE",
    authDomain: "mitalky.firebaseapp.com",
    projectId: "mitalky",
    storageBucket: "mitalky.appspot.com",
    messagingSenderId: "753557195623",
    appId: "1:753557195623:web:abc3b37eca5d67c9157dc2"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // userId unique localStorage
  function getUserId() {
    let userId = localStorage.getItem('userId');
    if(!userId) {
      userId = 'user_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('userId', userId);
    }
    return userId;
  }
  const userId = getUserId();

  const pubList = document.getElementById('pubList');
  const errorMsg = document.getElementById('errorMsg');

  // Fonction afficher pubs + boutons like + commentaires
  function renderPubs(docs) {
    if(docs.length === 0) {
      pubList.innerHTML = '<p>Aucune pub pour le moment.</p>';
      return;
    }
    pubList.innerHTML = '';

    docs.forEach(doc => {
      const data = doc.data();
      const id = doc.id;

      const div = document.createElement('div');
      div.className = 'pub';

      let content = `<p>${data.text}</p>`;
      if(data.url){
        content += `<a href="${data.url}" target="_blank" rel="noopener noreferrer">${data.url}</a><br/>`;
      }
      content += `<small style="color:#999">Cr√©√©e le: ${data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString() : 'Date inconnue'}</small>`;

      const likesCount = data.likesCount || 0;
      const likesBy = data.likesBy || [];
      const userLiked = likesBy.includes(userId);

      content += `<br/><button class="like-btn ${userLiked ? 'liked' : ''}" data-id="${id}">${userLiked ? '‚ù§Ô∏è Like' : 'ü§ç Like'}</button>
                  <span class="likes-count">${likesCount} like${likesCount !== 1 ? 's' : ''}</span>`;

      // Bouton pour afficher/cacher la section messages
      content += `<br/><button class="toggle-comments-btn" data-id="${id}">Afficher les messages</button>`;

      // Section commentaires cach√©e (sera affich√©e au clic)
      content += `
        <div class="messages-section" id="messages-section-${id}" style="display:none;">
          <div class="messages-list" id="messages-list-${id}">Chargement des messages...</div>
          <textarea id="input-message-${id}" rows="2" placeholder="√âcrire un message..."></textarea>
          <button class="send-message-btn" data-id="${id}">Envoyer</button>
          <div class="error" id="error-msg-${id}"></div>
        </div>
      `;

      div.innerHTML = content;
      pubList.appendChild(div);
    });

    // Like boutons
    document.querySelectorAll('.like-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const pubId = btn.getAttribute('data-id');
        toggleLike(pubId, btn);
      });
    });

    // Toggle commentaires
    document.querySelectorAll('.toggle-comments-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const pubId = btn.getAttribute('data-id');
        const section = document.getElementById(`messages-section-${pubId}`);
        if(section.style.display === 'none'){
          section.style.display = 'block';
          btn.textContent = "Cacher les messages";
          loadMessages(pubId);
        } else {
          section.style.display = 'none';
          btn.textContent = "Afficher les messages";
        }
      });
    });

    // Envoi message
    document.querySelectorAll('.send-message-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const pubId = btn.getAttribute('data-id');
        sendMessage(pubId);
      });
    });
  }

  // Toggle like/unlike
  function toggleLike(pubId, btn) {
    const pubRef = db.collection('pubs').doc(pubId);
    db.runTransaction(async (transaction) => {
      const doc = await transaction.get(pubRef);
      if(!doc.exists) throw "Pub introuvable";

      const data = doc.data();
      let likesBy = data.likesBy || [];
      let likesCount = data.likesCount || 0;

      if(likesBy.includes(userId)) {
        likesBy = likesBy.filter(uid => uid !== userId);
        likesCount = Math.max(0, likesCount - 1);
      } else {
        likesBy.push(userId);
        likesCount++;
      }

      transaction.update(pubRef, { likesBy, likesCount });
    }).then(() => {
      pubRef.get().then(doc => {
        if(doc.exists){
          const data = doc.data();
          const userLikedNow = data.likesBy.includes(userId);
          if(userLikedNow) {
            btn.classList.add('liked');
            btn.textContent = '‚ù§Ô∏è Like';
          } else {
            btn.classList.remove('liked');
            btn.textContent = 'ü§ç Like';
          }
          const countSpan = btn.nextElementSibling;
          countSpan.textContent = `${data.likesCount} like${data.likesCount !== 1 ? 's' : ''}`;
        }
      });
    }).catch(error => alert("Erreur lors du Like: " + error));
  }

  // Charger les messages pour un pub donn√© (subcollection "messages")
  function loadMessages(pubId) {
    const messagesList = document.getElementById(`messages-list-${pubId}`);
    messagesList.innerHTML = 'Chargement des messages...';

    db.collection('pubs').doc(pubId).collection('messages')
      .orderBy('createdAt', 'asc')
      .get()
      .then(snapshot => {
        if(snapshot.empty){
          messagesList.innerHTML = '<p>Aucun message pour cette pub.</p>';
          return;
        }
        messagesList.innerHTML = '';
        snapshot.forEach(doc => {
          const msg = doc.data();
          const dateStr = msg.createdAt ? new Date(msg.createdAt.seconds * 1000).toLocaleString() : 'Date inconnue';
          const div = document.createElement('div');
          div.className = 'message';
          div.innerHTML = `<span class="message-user">${msg.userId}</span>
                           <span class="message-time">${dateStr}</span>
                           <p>${msg.text}</p>`;
          messagesList.appendChild(div);
        });
      }).catch(error => {
        messagesList.innerHTML = `<p style="color:red;">Erreur chargement messages: ${error.message}</p>`;
      });
  }

  // Envoyer un message dans la subcollection "messages" du pub
  function sendMessage(pubId) {
    const input = document.getElementById(`input-message-${pubId}`);
    const errorDiv = document.getElementById(`error-msg-${pubId}`);
    const text = input.value.trim();
    errorDiv.textContent = '';

    if(!text) {
      errorDiv.textContent = "Le message est obligatoire.";
      return;
    }

    const btn = input.nextElementSibling; // bouton Envoyer
    btn.disabled = true;
    btn.textContent = "Envoi...";

    db.collection('pubs').doc(pubId).collection('messages').add({
      userId: userId,
      text: text,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
      input.value = '';
      btn.disabled = false;
      btn.textContent = "Envoyer";
      loadMessages(pubId); // rafra√Æchir messages
    }).catch(error => {
      errorDiv.textContent = "Erreur envoi message : " + error.message;
      btn.disabled = false;
      btn.textContent = "Envoyer";
    });
  }

  // Chargement en temps r√©el des pubs
  content += `<br/><button class="delete-pub-btn" data-id="${id}" style="background:#e0245e;">Supprimer Pub</button>`;
  db.collection('pubs').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
    renderPubs(snapshot.docs);
  }, error => {
    pubList.innerHTML = `<p style="color:red;">Erreur de chargement des pubs : ${error.message}</p>`;
  });

  // Cr√©ation pub via formulaire
  document.getElementById('btnCreatePub').addEventListener('click', () => {
    const text = document.getElementById('pubText').value.trim();
    const url = document.getElementById('pubUrl').value.trim();
    errorMsg.textContent = '';

    if(!text) {
      errorMsg.textContent = "Le texte de la pub est obligatoire.";
      return;
    }

    const btn = document.getElementById('btnCreatePub');
    btn.disabled = true;
    btn.textContent = 'Envoi en cours...';

    db.collection('pubs').add({
      text: text,
      url: url || '',
      likesCount: 0,
      likesBy: [],
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
      document.getElementById('pubText').value = '';
      document.getElementById('pubUrl').value = '';
      btn.disabled = false;
      btn.textContent = 'Cr√©er Pub';
    }).catch(error => {
      errorMsg.textContent = "Erreur lors de la cr√©ation de la pub : " + error.message;
      btn.disabled = false;
      btn.textContent = 'Cr√©er Pub';
    });
  });
// Supprimer un message donn√©
function deleteMessage(pubId, messageId) {
  if (!confirm("Voulez-vous vraiment supprimer ce message ?")) return;

  db.collection('pubs').doc(pubId).collection('messages').doc(messageId)
    .delete()
    .then(() => {
      loadMessages(pubId); // rafra√Æchir
  snapshot.forEach(doc => {
  const msg = doc.data();
  const dateStr = msg.createdAt ? new Date(msg.createdAt.seconds * 1000).toLocaleString() : 'Date inconnue';
  const div = document.createElement('div');
  div.className = 'message';

  div.innerHTML = `
    <span class="message-user">${msg.userId}</span>
    <span class="message-time">${dateStr}</span>
    <p>${msg.text}</p>
    <button class="delete-message-btn" data-pub-id="${pubId}" data-msg-id="${doc.id}" style="background:#e0245e; font-size:0.8em; margin-top:5px;">Supprimer</button>
  `;

  messagesList.appendChild(div);
});

// Apr√®s la boucle forEach, ajouter √©couteurs suppression message :
messagesList.querySelectorAll('.delete-message-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const pubId = btn.getAttribute('data-pub-id');
    const msgId = btn.getAttribute('data-msg-id');
    deleteMessage(pubId, msgId);
  });
});

    })
    .catch(error => {
      alert("Erreur suppression message : " + error.message);
    });
}

// Supprimer une pub et ses messages (messages supprim√©s en batch)
async function deletePub(pubId) {
  if (!confirm("Voulez-vous vraiment supprimer cette pub et tous ses messages ?")) return;

  const pubRef = db.collection('pubs').doc(pubId);
  try {
    // Supprimer les messages de la subcollection "messages"
    const messagesSnapshot = await pubRef.collection('messages').get();
    const batch = db.batch();
    messagesSnapshot.forEach(doc => {
      batch.delete(doc.ref);
    });
    batch.delete(pubRef); // supprimer la pub elle-m√™me
    await batch.commit();
    // Pub supprim√©e, Firestore onSnapshot va rafra√Æchir la liste
  } catch (error) {
    alert("Erreur suppression pub : " + error.message);
  }
}
// Bouton suppression pub
document.querySelectorAll('.delete-pub-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const pubId = btn.getAttribute('data-id');
    deletePub(pubId);
  });
});


</script>

</body>
</html>
