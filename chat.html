<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Test Pub Firebase</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 600px;
    margin: 30px auto;
    background: #f9f9f9;
    padding: 20px;
    border-radius: 8px;
  }
  h2 {
    color: #1877f2;
  }
  label {
    display: block;
    margin-top: 15px;
    font-weight: bold;
  }
  input[type="text"], textarea {
    width: 100%;
    padding: 10px;
    margin-top: 5px;
    border-radius: 6px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
  button {
    margin-top: 15px;
    background: #1877f2;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
  }
  button:hover:not(:disabled) {
    background: #145dbf;
  }
  button:disabled {
    background: #a3c0f9;
    cursor: not-allowed;
  }
  .pub {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin-top: 20px;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
    position: relative;
  }
  .pub a {
    color: #1877f2;
    text-decoration: none;
  }
  .pub a:hover {
    text-decoration: underline;
  }
  .deleteBtn {
    position: absolute;
    top: 12px;
    right: 12px;
    background: #ff4d4d;
    border: none;
    color: white;
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
  }
  .deleteBtn:hover {
    background: #e04343;
  }
  #searchInput {
    margin-top: 20px;
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<h2>Créer une Pub</h2>

<label for="pubText">Texte de la Pub :</label>
<textarea id="pubText" rows="3" placeholder="Écrivez votre message publicitaire ici..."></textarea>

<label for="pubUrl">Lien du site (optionnel) :</label>
<input type="text" id="pubUrl" placeholder="https://exemple.com" />

<button id="btnCreatePub">Créer Pub</button>

<h2>Recherche dans les Pubs</h2>
<input type="text" id="searchInput" placeholder="Recherche texte ou URL..." />

<h2>Liste des Pubs</h2>
<div id="pubList">Chargement...</div>

<script>
  // Votre config Firebase (changez par la vôtre)
  const firebaseConfig = {
    apiKey: "AIzaSyAzcnb-eswHt_pDi7tCvcIBzlzejCprJfE",
    authDomain: "mitalky.firebaseapp.com",
    projectId: "mitalky",
    storageBucket: "mitalky.appspot.com",
    messagingSenderId: "753557195623",
    appId: "1:753557195623:web:abc3b37eca5d67c9157dc2"
  };

  // Initialiser Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const pubText = document.getElementById('pubText');
  const pubUrl = document.getElementById('pubUrl');
  const btnCreatePub = document.getElementById('btnCreatePub');
  const pubList = document.getElementById('pubList');
  const searchInput = document.getElementById('searchInput');

  // Stocker pubs localement pour recherche
  let pubsCache = [];

  // Fonction pour afficher pubs avec suppression
  function renderPubs(pubs) {
    if(pubs.length === 0) {
      pubList.innerHTML = '<p>Aucune pub pour le moment.</p>';
      return;
    }
    pubList.innerHTML = '';
    pubs.forEach(doc => {
      const data = doc.data();
      const div = document.createElement('div');
      div.className = 'pub';
      let content = `<p>${data.text}</p>`;
      if(data.url){
        content += `<a href="${data.url}" target="_blank" rel="noopener noreferrer">${data.url}</a>`;
      }
      content += `<br><small style="color:#999">Créée le: ${data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString() : 'Date inconnue'}</small>`;
      div.innerHTML = content;

      // Bouton suppression
      const btnDel = document.createElement('button');
      btnDel.textContent = 'Supprimer';
      btnDel.className = 'deleteBtn';
      btnDel.onclick = () => {
        if(confirm('Voulez-vous vraiment supprimer cette pub ?')) {
          db.collection('pubs').doc(doc.id).delete().catch(err=>{
            alert("Erreur suppression : " + err.message);
          });
        }
      };
      div.appendChild(btnDel);

      pubList.appendChild(div);
    });
  }

  // Charger pubs en temps réel et stocker dans cache
  db.collection('pubs').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
    pubsCache = snapshot.docs;
    applySearchFilter();
  }, error => {
    pubList.innerHTML = `<p style="color:red;">Erreur de chargement des pubs : ${error.message}</p>`;
  });

  // Créer une pub
  btnCreatePub.addEventListener('click', () => {
    const text = pubText.value.trim();
    const url = pubUrl.value.trim();

    if(!text) {
      alert('Le texte de la pub est obligatoire.');
      return;
    }

    btnCreatePub.disabled = true;
    btnCreatePub.textContent = 'Envoi en cours...';

    db.collection('pubs').add({
      text: text,
      url: url || '',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
      pubText.value = '';
      pubUrl.value = '';
      btnCreatePub.disabled = false;
      btnCreatePub.textContent = 'Créer Pub';
      alert('Pub créée avec succès !');
    }).catch(error => {
      alert('Erreur lors de la création de la pub : ' + error.message);
      btnCreatePub.disabled = false;
      btnCreatePub.textContent = 'Créer Pub';
    });
  });

  // Recherche simple en JS dans pubsCache
  function applySearchFilter() {
    const query = searchInput.value.trim().toLowerCase();
    if(!query) {
      renderPubs(pubsCache);
      return;
    }
    const filtered = pubsCache.filter(doc => {
      const data = doc.data();
      return (data.text && data.text.toLowerCase().includes(query)) || 
             (data.url && data.url.toLowerCase().includes(query));
    });
    renderPubs(filtered);
  }

  // Écouter l'input de recherche
  searchInput.addEventListener('input', () => {
    applySearchFilter();
  });

</script>

</body>
</html>
