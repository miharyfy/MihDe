<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Créer une Pub avec Firebase</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 480px;
    margin: 30px auto;
    background: #f9fafb;
    padding: 20px;
    border-radius: 14px;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
  }
  h2 {
    text-align: center;
    color: #1877f2;
    margin-bottom: 24px;
  }
  label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    color: #333;
  }
  input[type="text"], input[type="url"], textarea {
    width: 100%;
    padding: 10px 12px;
    margin-bottom: 16px;
    border-radius: 8px;
    border: 1.8px solid #ccc;
    font-size: 14px;
    box-sizing: border-box;
    transition: border-color 0.3s ease;
  }
  input[type="text"]:focus, input[type="url"]:focus, textarea:focus {
    border-color: #1877f2;
    outline: none;
  }
  textarea {
    resize: vertical;
    min-height: 90px;
  }
  .error {
    color: #cc0000;
    font-size: 13px;
    margin-top: -12px;
    margin-bottom: 12px;
  }
  button {
    background-color: #1877f2;
    color: white;
    border: none;
    padding: 14px 20px;
    font-size: 16px;
    font-weight: 700;
    border-radius: 12px;
    cursor: pointer;
    width: 100%;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: #145dbf;
  }
  .pubsList {
    margin-top: 32px;
  }
  .pubItem {
    background: #e7f0fe;
    border-radius: 12px;
    padding: 14px 16px;
    margin-bottom: 12px;
    word-wrap: break-word;
  }
  .pubItem a {
    color: #145dbf;
    text-decoration: underline;
  }
  .pubText {
    white-space: pre-wrap;
  }
  .pubMeta {
    font-size: 12px;
    color: #666;
    margin-top: 8px;
  }
</style>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

</head>
<body>

<h2>Créer une Pub</h2>

<form id="pubForm" novalidate>
  <label for="pubText">Texte de la pub <span style="color:#cc0000;">*</span></label>
  <textarea id="pubText" placeholder="Écrivez votre publicité ici..." required></textarea>
  <div id="textError" class="error" style="display:none;">Le texte est obligatoire.</div>
  
  <label for="pubURL">Lien URL (optionnel)</label>
  <input type="url" id="pubURL" placeholder="https://exemple.com" />
  <div id="urlError" class="error" style="display:none;">Veuillez entrer une URL valide.</div>
  
  <button type="submit">Valider la pub</button>
</form>

<div class="pubsList" id="pubsList"></div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAzcnb-eswHt_pDi7tCvcIBzlzejCprJfE",
    authDomain: "mitalky.firebaseapp.com",
    projectId: "mitalky",
    storageBucket: "mitalky.appspot.com",
    messagingSenderId: "753557195623",
    appId: "1:753557195623:web:abc3b37eca5d67c9157dc2"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const form = document.getElementById('pubForm');
  const textInput = document.getElementById('pubText');
  const urlInput = document.getElementById('pubURL');
  const textError = document.getElementById('textError');
  const urlError = document.getElementById('urlError');
  const pubsList = document.getElementById('pubsList');

  // Escape HTML helper to prevent XSS
  function escapeHtml(str) {
    if(!str) return '';
    return str.replace(/[&<>"']/g, m => ({
      '&':'&amp;',
      '<':'&lt;',
      '>':'&gt;',
      '"':'&quot;',
      "'":'&#39;'
    }[m]));
  }

  // Show all pubs from Firestore in real time
  function showPubsRealtime() {
    db.collection('pubs').orderBy('createdAt', 'desc')
      .onSnapshot(snapshot => {
        pubsList.innerHTML = '';
        if(snapshot.empty){
          pubsList.innerHTML = '<p style="color:#666;text-align:center;">Pas encore de pub.</p>';
          return;
        }
        snapshot.forEach(doc => {
          const p = doc.data();
          const pubText = escapeHtml(p.text).replace(/\n/g, '<br>');
          const pubURL = p.url ? `<br><a href="${escapeHtml(p.url)}" target="_blank" rel="noopener">${escapeHtml(p.url)}</a>` : '';
          const date = p.createdAt ? new Date(p.createdAt.seconds * 1000).toLocaleString() : '';
          const pubHTML = `
            <div class="pubItem">
              <div class="pubText">${pubText}${pubURL}</div>
              <div class="pubMeta">Créé le ${date}</div>
            </div>`;
          pubsList.insertAdjacentHTML('beforeend', pubHTML);
        });
      });
  }

  showPubsRealtime();

  // Form submit
  form.addEventListener('submit', (e) => {
    e.preventDefault();

    // Reset errors
    textError.style.display = 'none';
    urlError.style.display = 'none';

    let valid = true;

    // Validate text
    if(textInput.value.trim() === '') {
      textError.style.display = 'block';
      valid = false;
    }

    // Validate URL if not empty
    if(urlInput.value.trim() !== '') {
      try {
        new URL(urlInput.value.trim());
      } catch {
        urlError.style.display = 'block';
        valid = false;
      }
    }

    if(!valid) return;

    // Add pub to Firestore
    db.collection('pubs').add({
      text: textInput.value.trim(),
      url: urlInput.value.trim() || null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
      form.reset();
    }).catch(err => {
      alert('Erreur lors de la création de la pub: ' + err.message);
    });
  });
</script>

</body>
</html>
