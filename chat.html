<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pub Firebase avec Like & Tutoriel & Suppression</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 700px;
    margin: 30px auto;
    background: #f0f4ff;
    padding: 20px;
    border-radius: 8px;
  }
  h2 {
    color: #1877f2;
  }
  label {
    font-weight: bold;
    display: block;
    margin-top: 15px;
  }
  input[type="text"], textarea {
    width: 100%;
    padding: 10px;
    margin-top: 5px;
    border-radius: 6px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
  button {
    margin-top: 15px;
    background: #1877f2;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
  }
  button:hover {
    background: #145dbf;
  }
  .pub {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin-top: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    position: relative;
  }
  .pub a {
    color: #1877f2;
    text-decoration: none;
  }
  .pub a:hover {
    text-decoration: underline;
  }
  .like-btn, .delete-btn {
    background: transparent;
    border: none;
    color: #1877f2;
    font-weight: bold;
    cursor: pointer;
    margin-top: 10px;
    margin-right: 10px;
  }
  .like-btn.liked {
    color: #e0245e;
  }
  .likes-count {
    font-size: 0.9em;
    color: #555;
    margin-left: 10px;
  }
  .error {
    color: red;
    margin-top: 8px;
  }
  .tutorial {
    background: #dbe9ff;
    border: 2px solid #1877f2;
    padding: 15px;
    margin-top: 40px;
    border-radius: 8px;
  }
  .tutorial h3 {
    margin-top: 0;
    color: #145dbf;
  }
  .tutorial ol {
    padding-left: 20px;
  }
</style>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<h2>Cr√©er une Pub</h2>
<label for="pubText">Texte de la Pub :</label>
<textarea id="pubText" rows="3" placeholder="√âcrivez votre message publicitaire ici..."></textarea>

<label for="pubUrl">Lien du site (optionnel) :</label>
<input type="text" id="pubUrl" placeholder="https://exemple.com" />

<button id="btnCreatePub">Cr√©er Pub</button>
<div id="errorMsg" class="error"></div>

<h2>Liste des Pubs</h2>
<div id="pubList">Chargement...</div>

<!-- Tutoriel simple -->
<div class="tutorial">
  <h3>Comment cr√©er une Pub ?</h3>
  <ol>
    <li>√âcrivez un texte publicitaire dans la zone "Texte de la Pub".</li>
    <li>Ajoutez un lien URL si vous voulez, sinon laissez vide.</li>
    <li>Cliquez sur "Cr√©er Pub" pour enregistrer votre pub.</li>
    <li>Votre pub appara√Ætra dans la liste avec un bouton Like.</li>
    <li>Cliquez sur "Like" pour montrer que vous aimez cette pub !</li>
    <li><strong>Nouveau:</strong> Vous pouvez supprimer une pub avec le bouton "Supprimer".</li>
  </ol>
  <p><strong>Note:</strong> Chaque utilisateur a un identifiant unique dans son navigateur, donc un seul like par pub par utilisateur.</p>
</div>

<script>
  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAzcnb-eswHt_pDi7tCvcIBzlzejCprJfE",
    authDomain: "mitalky.firebaseapp.com",
    projectId: "mitalky",
    storageBucket: "mitalky.appspot.com",
    messagingSenderId: "753557195623",
    appId: "1:753557195623:web:abc3b37eca5d67c9157dc2"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // G√©n√©rer un userId unique stock√© en localStorage
  function getUserId() {
    let userId = localStorage.getItem('userId');
    if(!userId) {
      userId = 'user_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('userId', userId);
    }
    return userId;
  }
  const userId = getUserId();

  const pubList = document.getElementById('pubList');
  const errorMsg = document.getElementById('errorMsg');

  // Fonction pour afficher pubs avec Like et Delete buttons
  function renderPubs(docs) {
    if(docs.length === 0) {
      pubList.innerHTML = '<p>Aucune pub pour le moment.</p>';
      return;
    }
    pubList.innerHTML = '';
    docs.forEach(doc => {
      const data = doc.data();
      const id = doc.id;

      const div = document.createElement('div');
      div.className = 'pub';

      let content = `<p>${data.text}</p>`;
      if(data.url){
        content += `<a href="${data.url}" target="_blank" rel="noopener noreferrer">${data.url}</a><br/>`;
      }
      content += `<small style="color:#999">Cr√©√©e le: ${data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString() : 'Date inconnue'}</small>`;

      const likesCount = data.likesCount || 0;
      const likesBy = data.likesBy || [];

      const userLiked = likesBy.includes(userId);

      content += `<br/>
        <button class="like-btn ${userLiked ? 'liked' : ''}" data-id="${id}">${userLiked ? '‚ù§Ô∏è Like' : 'ü§ç Like'}</button>
        <span class="likes-count">${likesCount} like${likesCount !== 1 ? 's' : ''}</span>
        <button class="delete-btn" data-id="${id}" title="Supprimer cette pub">üóë Supprimer</button>
      `;

      div.innerHTML = content;
      pubList.appendChild(div);
    });

    // Ajouter √©couteurs boutons Like
    document.querySelectorAll('.like-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const pubId = btn.getAttribute('data-id');
        toggleLike(pubId, btn);
      });
    });

    // Ajouter √©couteurs boutons Delete
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const pubId = btn.getAttribute('data-id');
        if(confirm("√ätes-vous s√ªr de vouloir supprimer cette pub ?")) {
          deletePub(pubId);
        }
      });
    });
  }

  // Fonction toggle like/unlike avec transaction Firestore
  function toggleLike(pubId, btn) {
    const pubRef = db.collection('pubs').doc(pubId);

    db.runTransaction(async (transaction) => {
      const doc = await transaction.get(pubRef);
      if(!doc.exists) throw "Pub introuvable";

      const data = doc.data();
      let likesBy = data.likesBy || [];
      let likesCount = data.likesCount || 0;

      if(likesBy.includes(userId)) {
        // Unlike
        likesBy = likesBy.filter(uid => uid !== userId);
        likesCount = Math.max(0, likesCount - 1);
      } else {
        // Like
        likesBy.push(userId);
        likesCount++;
      }

      transaction.update(pubRef, {
        likesBy: likesBy,
        likesCount: likesCount
      });
    }).then(() => {
      // Rafra√Æchir le bouton like apr√®s transaction
      pubRef.get().then(doc => {
        if(doc.exists){
          const data = doc.data();
          const userLikedNow = data.likesBy.includes(userId);
          if(userLikedNow) {
            btn.classList.add('liked');
            btn.textContent = '‚ù§Ô∏è Like';
          } else {
            btn.classList.remove('liked');
            btn.textContent = 'ü§ç Like';
          }
          const countSpan = btn.nextElementSibling;
          countSpan.textContent = `${data.likesCount} like${data.likesCount !== 1 ? 's' : ''}`;
        }
      });
    }).catch(error => {
      alert("Erreur lors du Like: " + error);
    });
  }

  // Fonction suppression pub
  function deletePub(pubId) {
    db.collection('pubs').doc(pubId).delete()
    .then(() => {
      alert("Pub supprim√©e avec succ√®s !");
    })
    .catch(error => {
      alert("Erreur lors de la suppression: " + error.message);
    });
  }

  // Chargement en temps r√©el des pubs depuis Firestore
  db.collection('pubs').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
    renderPubs(snapshot.docs);
  }, error => {
    pubList.innerHTML = `<p style="color:red;">Erreur de chargement des pubs : ${error.message}</p>`;
  });

  // Cr√©ation pub via formulaire
  document.getElementById('btnCreatePub').addEventListener('click', () => {
    const text = document.getElementById('pubText').value.trim();
    const url = document.getElementById('pubUrl').value.trim();
    errorMsg.textContent = '';

    if(!text) {
      errorMsg.textContent = "Le texte de la pub est obligatoire.";
      return;
    }

    // D√©sactiver bouton le temps de l'envoi
    const btn = document.getElementById('btnCreatePub');
    btn.disabled = true;
    btn.textContent = 'Envoi en cours...';

    db.collection('pubs').add({
      text: text,
      url: url || '',
      likesCount: 0,
      likesBy: [],
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
      document.getElementById('pubText').value = '';
      document.getElementById('pubUrl').value = '';
      btn.disabled = false;
      btn.textContent = 'Cr√©er Pub';
    }).catch(error => {
      errorMsg.textContent = "Erreur lors de la cr√©ation de la pub : " + error.message;
      btn.disabled = false;
      btn.textContent = 'Cr√©er Pub';
    });
  });
</script>

</body>
</html>
