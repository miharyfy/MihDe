<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Chat</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #e9ebee;
    margin: 0;
    padding: 0;
    height: 100vh;
    display: flex;
  }
  /* Sidebar */
  #sidebar {
    width: 250px;
    background: #fff;
    border-right: 1px solid #ccc;
    display: flex;
    flex-direction: column;
  }
  #searchUser {
    padding: 10px;
    border-bottom: 1px solid #ddd;
  }
  #searchUser input {
    width: 100%;
    padding: 8px;
    border-radius: 20px;
    border: 1px solid #ccc;
    outline: none;
  }
  #userList {
    flex: 1;
    overflow-y: auto;
  }
  .user-item {
    display: flex;
    align-items: center;
    padding: 10px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .user-item:hover {
    background: #f0f2f5;
  }
  /* Chat container */
  #container {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100vh;
    background: #fff;
  }
  #chatHeader {
    padding: 10px;
    background: #1877f2;
    color: white;
    font-weight: bold;
  }
  #chatBox {
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px;
    background-color: #f9f9f9;
    display: flex;
    flex-direction: column;
  }
  .message {
    max-width: 70%;
    padding: 10px 15px;
    margin-bottom: 10px;
    border-radius: 15px;
    line-height: 1.4;
    font-size: 15px;
    animation: fadeIn 0.4s ease;
  }
  .sent {
    background-color: #d2e3fc;
    align-self: flex-end;
    border-bottom-right-radius: 0;
  }
  .received {
    background-color: #f1f0f0;
    align-self: flex-start;
    border-bottom-left-radius: 0;
  }
  #sendMsgDiv {
    display: flex;
    padding: 10px;
    background: #fff;
    border-top: 1px solid #ccc;
  }
  #msg {
    flex-grow: 1;
    padding: 10px;
    border-radius: 20px;
    border: 1px solid #ccc;
    outline: none;
  }
  #sendBtn {
    background: #1877f2;
    border: none;
    color: white;
    padding: 0 20px;
    margin-left: 8px;
    border-radius: 20px;
    cursor: pointer;
    transition: background 0.3s;
  }
  #sendBtn:hover {
    background: #145dbf;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<!-- Sidebar -->
<div id="sidebar">
  <div id="searchUser">
    <input type="text" id="searchInput" placeholder="Mitady olona...">
  </div>
  <div id="userList"></div>
</div>

<!-- Main Chat -->
<div id="container">
  <div id="chatHeader">Safidio ny olona</div>
  <div id="chatBox"></div>
  <div id="sendMsgDiv">
    <input id="msg" placeholder="Lazao hafatra" />
    <button id="sendBtn" onclick="sendMsg()">Alefa</button>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAzcnb-eswHt_pDi7tCvcIBzlzejCprJfE",
    authDomain: "mitalky.firebaseapp.com",
    projectId: "mitalky",
    storageBucket: "mitalky.appspot.com",
    messagingSenderId: "753557195623",
    appId: "1:753557195623:web:abc3b37eca5d67c9157dc2"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let myUid, myId, otherUid;

  auth.onAuthStateChanged(user => {
    if (!user) return window.location.href = "nextpage.html";
    myUid = user.uid;
    db.collection("users").doc(myUid).get().then(doc => {
      if (!doc.exists) return window.location.href = "dashboard.html";
      myId = doc.data().id;
      loadUserList();
    });
  });

  // Load all contacts
  function loadUserList() {
    db.collection("users").get().then(snapshot => {
      const listDiv = document.getElementById("userList");
      listDiv.innerHTML = "";
      snapshot.forEach(doc => {
        if (doc.id !== myUid) {
          const data = doc.data();
          const item = document.createElement("div");
          item.classList.add("user-item");
          item.textContent = data.id + " - " + (data.name || "Anarana tsy voafaritra");
          item.onclick = () => {
            otherUid = doc.id;
            document.getElementById("chatHeader").textContent = data.name || data.id;
            listenToMessages();
          };
          listDiv.appendChild(item);
        }
      });
    });
  }

  // Search
  document.getElementById("searchInput").addEventListener("input", function() {
    const term = this.value.toLowerCase();
    document.querySelectorAll(".user-item").forEach(item => {
      item.style.display = item.textContent.toLowerCase().includes(term) ? "flex" : "none";
    });
  });

  // Listen messages
  function listenToMessages() {
    const chatId = [myUid, otherUid].sort().join("_");
    db.collection("chats").doc(chatId).collection("messages")
      .orderBy("time")
      .onSnapshot(snapshot => {
        const box = document.getElementById("chatBox");
        box.innerHTML = "";
        snapshot.forEach(doc => {
          const msg = doc.data();
          const div = document.createElement("div");
          div.classList.add("message", msg.from === myUid ? "sent" : "received");
          div.textContent = msg.text;
          box.appendChild(div);
        });
        box.scrollTop = box.scrollHeight;
      });
  }

  // Send message
  function sendMsg() {
    const text = document.getElementById("msg").value.trim();
    if (!text || !otherUid) return;
    const chatId = [myUid, otherUid].sort().join("_");
    db.collection("chats").doc(chatId).collection("messages").add({
      from: myUid,
      text,
      time: firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById("msg").value = "";
  }
</script>

</body>
</html>
