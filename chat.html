<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pub avec Like & Suppression</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 600px;
    margin: 30px auto;
    background: #f0f4ff;
    padding: 20px;
    border-radius: 8px;
  }
  h2 {
    color: #1877f2;
  }
  .pub {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin-top: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    position: relative;
  }
  .pub a {
    color: #1877f2;
    text-decoration: none;
  }
  .pub a:hover {
    text-decoration: underline;
  }
  .like-btn, .delete-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    font-weight: bold;
    margin-top: 10px;
    font-size: 14px;
  }
  .like-btn {
    color: #1877f2;
    margin-right: 15px;
  }
  .liked {
    color: #e0245e; /* rose rouge like */
  }
  .delete-btn {
    color: #cc0000;
    float: right;
  }
  .likes-count {
    font-size: 0.9em;
    color: #555;
    margin-left: 5px;
  }
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<h2>Liste des Pubs</h2>
<div id="pubList">Chargement...</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAzcnb-eswHt_pDi7tCvcIBzlzejCprJfE",
    authDomain: "mitalky.firebaseapp.com",
    projectId: "mitalky",
    storageBucket: "mitalky.appspot.com",
    messagingSenderId: "753557195623",
    appId: "1:753557195623:web:abc3b37eca5d67c9157dc2"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  function getUserId() {
    let userId = localStorage.getItem('userId');
    if(!userId) {
      userId = 'user_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('userId', userId);
    }
    return userId;
  }
  const userId = getUserId();

  const pubList = document.getElementById('pubList');

  function renderPubs(docs) {
    if(docs.length === 0) {
      pubList.innerHTML = '<p>Aucune pub pour le moment.</p>';
      return;
    }
    pubList.innerHTML = '';
    docs.forEach(doc => {
      const data = doc.data();
      const id = doc.id;

      const div = document.createElement('div');
      div.className = 'pub';

      let content = `<p>${data.text}</p>`;
      if(data.url){
        content += `<a href="${data.url}" target="_blank" rel="noopener noreferrer">${data.url}</a>`;
      }
      content += `<br/><small style="color:#999">Cr√©√©e le: ${data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString() : 'Date inconnue'}</small>`;

      const likesCount = data.likesCount || 0;
      const likesBy = data.likesBy || [];

      const userLiked = likesBy.includes(userId);

      content += `
        <button class="like-btn ${userLiked ? 'liked' : ''}" data-id="${id}">
          ${userLiked ? '‚ù§Ô∏è Like' : 'ü§ç Like'}
        </button>
        <span class="likes-count">${likesCount} like${likesCount !== 1 ? 's' : ''}</span>
        <button class="delete-btn" data-id="${id}" title="Supprimer cette pub">üóë Supprimer</button>
      `;

      div.innerHTML = content;
      pubList.appendChild(div);
    });

    // Like btn listeners
    document.querySelectorAll('.like-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const pubId = btn.getAttribute('data-id');
        toggleLike(pubId, btn);
      });
    });

    // Delete btn listeners
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const pubId = btn.getAttribute('data-id');
        if(confirm("Voulez-vous vraiment supprimer cette pub ?")) {
          db.collection('pubs').doc(pubId).delete()
          .catch(err => alert("Erreur lors de la suppression : " + err.message));
        }
      });
    });
  }

  function toggleLike(pubId, btn) {
    const pubRef = db.collection('pubs').doc(pubId);

    db.runTransaction(async (transaction) => {
      const doc = await transaction.get(pubRef);
      if(!doc.exists) throw "Pub introuvable";

      const data = doc.data();
      let likesBy = data.likesBy || [];
      let likesCount = data.likesCount || 0;

      if(likesBy.includes(userId)) {
        likesBy = likesBy.filter(uid => uid !== userId);
        likesCount = Math.max(0, likesCount - 1);
      } else {
        likesBy.push(userId);
        likesCount++;
      }

      transaction.update(pubRef, {
        likesBy: likesBy,
        likesCount: likesCount
      });
    }).catch(error => {
      alert("Erreur lors du Like: " + error);
    });
  }

  db.collection('pubs').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
    renderPubs(snapshot.docs);
  }, error => {
    pubList.innerHTML = `<p style="color:red;">Erreur de chargement des pubs : ${error.message}</p>`;
  });
</script>

</body>
</html>
