<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pub Firebase avec Like & Messages</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 700px;
    margin: 30px auto;
    background: #f0f4ff;
    padding: 20px;
    border-radius: 8px;
  }
  h2 {
    color: #1877f2;
  }
  label {
    font-weight: bold;
    display: block;
    margin-top: 15px;
  }
  input[type="text"], textarea {
    width: 100%;
    padding: 10px;
    margin-top: 5px;
    border-radius: 6px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
  button {
    margin-top: 15px;
    background: #1877f2;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
  }
  button:hover {
    background: #145dbf;
  }
  .pub, .message {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin-top: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    position: relative;
  }
  .pub a {
    color: #1877f2;
    text-decoration: none;
  }
  .pub a:hover {
    text-decoration: underline;
  }
  .like-btn {
    background: transparent;
    border: none;
    color: #1877f2;
    font-weight: bold;
    cursor: pointer;
    margin-top: 10px;
  }
  .liked {
    color: #e0245e;
  }
  .likes-count {
    font-size: 0.9em;
    color: #555;
    margin-left: 10px;
  }
  .error {
    color: red;
    margin-top: 8px;
  }
  .messages-section {
    margin-top: 50px;
  }
  .message-user {
    font-weight: bold;
    color: #1877f2;
  }
  .message-time {
    font-size: 0.8em;
    color: #888;
    margin-left: 10px;
  }
</style>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<h2>Cr√©er une Pub</h2>
<label for="pubText">Texte de la Pub :</label>
<textarea id="pubText" rows="3" placeholder="√âcrivez votre message publicitaire ici..."></textarea>

<label for="pubUrl">Lien du site (optionnel) :</label>
<input type="text" id="pubUrl" placeholder="https://exemple.com" />

<button id="btnCreatePub">Cr√©er Pub</button>
<div id="errorMsg" class="error"></div>

<h2>Liste des Pubs</h2>
<div id="pubList">Chargement...</div>

<!-- Section Messages -->
<div class="messages-section">
  <h2>Envoyer un Message</h2>
  <label for="messageText">Votre Message :</label>
  <textarea id="messageText" rows="3" placeholder="√âcrivez votre message ici..."></textarea>
  <button id="btnSendMessage">Envoyer Message</button>
  <div id="msgError" class="error"></div>

  <h2>Messages re√ßus</h2>
  <div id="messageList">Chargement des messages...</div>
</div>

<script>
  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAzcnb-eswHt_pDi7tCvcIBzlzejCprJfE",
    authDomain: "mitalky.firebaseapp.com",
    projectId: "mitalky",
    storageBucket: "mitalky.appspot.com",
    messagingSenderId: "753557195623",
    appId: "1:753557195623:web:abc3b37eca5d67c9157dc2"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // G√©n√©rer un userId unique stock√© en localStorage
  function getUserId() {
    let userId = localStorage.getItem('userId');
    if(!userId) {
      userId = 'user_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('userId', userId);
    }
    return userId;
  }
  const userId = getUserId();

  const pubList = document.getElementById('pubList');
  const errorMsg = document.getElementById('errorMsg');
  const messageList = document.getElementById('messageList');
  const msgError = document.getElementById('msgError');

  // AFFICHER LES PUBS (fonction identique)
  function renderPubs(docs) {
    if(docs.length === 0) {
      pubList.innerHTML = '<p>Aucune pub pour le moment.</p>';
      return;
    }
    pubList.innerHTML = '';
    docs.forEach(doc => {
      const data = doc.data();
      const id = doc.id;

      const div = document.createElement('div');
      div.className = 'pub';

      let content = `<p>${data.text}</p>`;
      if(data.url){
        content += `<a href="${data.url}" target="_blank" rel="noopener noreferrer">${data.url}</a><br/>`;
      }
      content += `<small style="color:#999">Cr√©√©e le: ${data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString() : 'Date inconnue'}</small>`;

      const likesCount = data.likesCount || 0;
      const likesBy = data.likesBy || [];

      const userLiked = likesBy.includes(userId);

      content += `<br/><button class="like-btn ${userLiked ? 'liked' : ''}" data-id="${id}">${userLiked ? '‚ù§Ô∏è Like' : 'ü§ç Like'}</button>
                  <span class="likes-count">${likesCount} like${likesCount !== 1 ? 's' : ''}</span>`;

      div.innerHTML = content;
      pubList.appendChild(div);
    });

    document.querySelectorAll('.like-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const pubId = btn.getAttribute('data-id');
        toggleLike(pubId, btn);
      });
    });
  }

  // Toggle like (identique)
  function toggleLike(pubId, btn) {
    const pubRef = db.collection('pubs').doc(pubId);

    db.runTransaction(async (transaction) => {
      const doc = await transaction.get(pubRef);
      if(!doc.exists) throw "Pub introuvable";

      const data = doc.data();
      let likesBy = data.likesBy || [];
      let likesCount = data.likesCount || 0;

      if(likesBy.includes(userId)) {
        likesBy = likesBy.filter(uid => uid !== userId);
        likesCount = Math.max(0, likesCount - 1);
      } else {
        likesBy.push(userId);
        likesCount++;
      }

      transaction.update(pubRef, {
        likesBy: likesBy,
        likesCount: likesCount
      });
    }).then(() => {
      pubRef.get().then(doc => {
        if(doc.exists){
          const data = doc.data();
          const userLikedNow = data.likesBy.includes(userId);
          if(userLikedNow) {
            btn.classList.add('liked');
            btn.textContent = '‚ù§Ô∏è Like';
          } else {
            btn.classList.remove('liked');
            btn.textContent = 'ü§ç Like';
          }
          const countSpan = btn.nextElementSibling;
          countSpan.textContent = `${data.likesCount} like${data.likesCount !== 1 ? 's' : ''}`;
        }
      });
    }).catch(error => {
      alert("Erreur lors du Like: " + error);
    });
  }

  // Chargement temps r√©el pubs
  db.collection('pubs').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
    renderPubs(snapshot.docs);
  }, error => {
    pubList.innerHTML = `<p style="color:red;">Erreur de chargement des pubs : ${error.message}</p>`;
  });

  // Cr√©ation pub
  document.getElementById('btnCreatePub').addEventListener('click', () => {
    const text = document.getElementById('pubText').value.trim();
    const url = document.getElementById('pubUrl').value.trim();
    errorMsg.textContent = '';

    if(!text) {
      errorMsg.textContent = "Le texte de la pub est obligatoire.";
      return;
    }

    const btn = document.getElementById('btnCreatePub');
    btn.disabled = true;
    btn.textContent = 'Envoi en cours...';

    db.collection('pubs').add({
      text: text,
      url: url || '',
      likesCount: 0,
      likesBy: [],
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
      document.getElementById('pubText').value = '';
      document.getElementById('pubUrl').value = '';
      btn.disabled = false;
      btn.textContent = 'Cr√©er Pub';
    }).catch(error => {
      errorMsg.textContent = "Erreur lors de la cr√©ation de la pub : " + error.message;
      btn.disabled = false;
      btn.textContent = 'Cr√©er Pub';
    });
  });

  // --- Partie Messages ---

  // Fonction afficher messages
  function renderMessages(docs) {
    if(docs.length === 0) {
      messageList.innerHTML = '<p>Aucun message pour le moment.</p>';
      return;
    }
    messageList.innerHTML = '';
    docs.forEach(doc => {
      const data = doc.data();
      const div = document.createElement('div');
      div.className = 'message';

      const dateStr = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString() : 'Date inconnue';
      div.innerHTML = `<span class="message-user">${data.userId}</span>
                       <span class="message-time">${dateStr}</span>
                       <p>${data.text}</p>`;
      messageList.appendChild(div);
    });
  }

  // Chargement temps r√©el messages
  db.collection('messages').orderBy('createdAt', 'desc').limit(30).onSnapshot(snapshot => {
    renderMessages(snapshot.docs);
  }, error => {
    messageList.innerHTML = `<p style="color:red;">Erreur de chargement des messages : ${error.message}</p>`;
  });

  // Envoyer un message
  document.getElementById('btnSendMessage').addEventListener('click', () => {
    const messageText = document.getElementById('messageText').value.trim();
    msgError.textContent = '';

    if(!messageText) {
      msgError.textContent = "Le message est obligatoire.";
      return;
    }

    const btn = document.getElementById('btnSendMessage');
    btn.disabled = true;
    btn.textContent = "Envoi en cours...";

    db.collection('messages').add({
      userId: userId,
      text: messageText,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
      document.getElementById('messageText').value = '';
      btn.disabled = false;
      btn.textContent = "Envoyer Message";
    }).catch(error => {
      msgError.textContent = "Erreur lors de l'envoi du message : " + error.message;
      btn.disabled = false;
      btn.textContent = "Envoyer Message";
    });
  });
</script>

</body>
</html>
