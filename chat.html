<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pub avec Like</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 600px;
    margin: 30px auto;
    background: #f0f4ff;
    padding: 20px;
    border-radius: 8px;
  }
  h2 {
    color: #1877f2;
  }
  .pub {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin-top: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    position: relative;
  }
  .pub a {
    color: #1877f2;
    text-decoration: none;
  }
  .pub a:hover {
    text-decoration: underline;
  }
  .like-btn {
    background: transparent;
    border: none;
    color: #1877f2;
    font-weight: bold;
    cursor: pointer;
    margin-top: 10px;
  }
  .liked {
    color: #e0245e; /* rose rouge like */
  }
  .likes-count {
    font-size: 0.9em;
    color: #555;
    margin-left: 10px;
  }
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<h2>Liste des Pubs</h2>
<div id="pubList">Chargement...</div>

<script>
  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAzcnb-eswHt_pDi7tCvcIBzlzejCprJfE",
    authDomain: "mitalky.firebaseapp.com",
    projectId: "mitalky",
    storageBucket: "mitalky.appspot.com",
    messagingSenderId: "753557195623",
    appId: "1:753557195623:web:abc3b37eca5d67c9157dc2"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // G√©n√©rer un userId simul√© unique stock√© en localStorage
  function getUserId() {
    let userId = localStorage.getItem('userId');
    if(!userId) {
      userId = 'user_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('userId', userId);
    }
    return userId;
  }
  const userId = getUserId();

  const pubList = document.getElementById('pubList');

  // Exemple de pub "sample" mivantana aseho raha mbola tsy misy ao amin'ny Firestore
  const samplePubData = [{
    id: 'sample1',
    text: "D√©couvrez notre super offre ! üéâ",
    url: "https://exemple.com",
    createdAt: new Date(),
    likesCount: 12,
    likesBy: ["user_abc", "user_xyz"]
  }];

  // Fonction pour afficher pubs avec gestion du pub sample si vide
  function renderPubs(docs) {
    pubList.innerHTML = '';

    if(docs.length === 0) {
      // Aucune pub dans Firestore, afficher sample
      samplePubData.forEach(pub => {
        const div = document.createElement('div');
        div.className = 'pub';

        let content = `<p>${pub.text}</p>`;
        if(pub.url){
          content += `<a href="${pub.url}" target="_blank" rel="noopener noreferrer">${pub.url}</a>`;
        }
        content += `<br/><small style="color:#999">Cr√©√©e le: ${pub.createdAt.toLocaleString()}</small>`;

        const likesCount = pub.likesCount || 0;
        const likesBy = pub.likesBy || [];
        const userLiked = likesBy.includes(userId);

        content += `<br/><button class="like-btn ${userLiked ? 'liked' : ''}" data-id="${pub.id}">
                      ${userLiked ? '‚ù§Ô∏è Like' : 'ü§ç Like'}
                    </button>
                    <span class="likes-count">${likesCount} like${likesCount !== 1 ? 's' : ''}</span>`;

        div.innerHTML = content;
        pubList.appendChild(div);
      });

      // Pas de gestion des likes sample car pas en DB
      return;
    }

    // Sinon afficher pubs r√©elles Firestore
    docs.forEach(doc => {
      const data = doc.data();
      const id = doc.id;

      const div = document.createElement('div');
      div.className = 'pub';

      let content = `<p>${data.text}</p>`;
      if(data.url){
        content += `<a href="${data.url}" target="_blank" rel="noopener noreferrer">${data.url}</a>`;
      }
      content += `<br/><small style="color:#999">Cr√©√©e le: ${data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString() : 'Date inconnue'}</small>`;

      const likesCount = data.likesCount || 0;
      const likesBy = data.likesBy || [];
      const userLiked = likesBy.includes(userId);

      content += `<br/><button class="like-btn ${userLiked ? 'liked' : ''}" data-id="${id}">
                    ${userLiked ? '‚ù§Ô∏è Like' : 'ü§ç Like'}
                  </button>
                  <span class="likes-count">${likesCount} like${likesCount !== 1 ? 's' : ''}</span>`;

      div.innerHTML = content;
      pubList.appendChild(div);
    });

    // Ajouter √©couteurs sur boutons like
    document.querySelectorAll('.like-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const pubId = btn.getAttribute('data-id');
        toggleLike(pubId, btn);
      });
    });
  }

  // Fonction toggle like/unlike
  function toggleLike(pubId, btn) {
    if(pubId.startsWith('sample')) {
      alert("Cette pub est un exemple, impossible de liker.");
      return; // Pas possible liker sample
    }
    const pubRef = db.collection('pubs').doc(pubId);

    db.runTransaction(async (transaction) => {
      const doc = await transaction.get(pubRef);
      if(!doc.exists) throw "Pub introuvable";

      const data = doc.data();
      let likesBy = data.likesBy || [];
      let likesCount = data.likesCount || 0;

      if(likesBy.includes(userId)) {
        // Unlike
        likesBy = likesBy.filter(uid => uid !== userId);
        likesCount = Math.max(0, likesCount - 1);
      } else {
        // Like
        likesBy.push(userId);
        likesCount++;
      }

      transaction.update(pubRef, {
        likesBy: likesBy,
        likesCount: likesCount
      });
    }).then(() => {
      // Mise √† jour pr√©cise √† partir de Firestore
      pubRef.get().then(doc => {
        if(doc.exists){
          const data = doc.data();
          const userLikedNow = data.likesBy.includes(userId);
          if(userLikedNow) {
            btn.classList.add('liked');
            btn.textContent = '‚ù§Ô∏è Like';
          } else {
            btn.classList.remove('liked');
            btn.textContent = 'ü§ç Like';
          }
          const countSpan = btn.nextElementSibling;
          countSpan.textContent = `${data.likesCount} like${data.likesCount !== 1 ? 's' : ''}`;
        }
      });
    }).catch(error => {
      alert("Erreur lors du Like: " + error);
    });
  }

  // Chargement en temps r√©el des pubs Firestore
  db.collection('pubs').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
    renderPubs(snapshot.docs);
  }, error => {
    pubList.innerHTML = `<p style="color:red;">Erreur de chargement des pubs : ${error.message}</p>`;
  });
</script>

</body>
</html>
