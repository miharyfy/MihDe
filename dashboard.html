auth.onAuthStateChanged(user => {
  if (!user) {
    window.location.href = "nextpage.html";
    return;
  }

  const uid = user.uid;

  db.collection("users").doc(uid).get().then(doc => {
    if (!doc.exists) {
      // Mamoròna profil vaovao
      const emailOrPhone = user.email || user.phoneNumber;
      const newId = generateUniqueID();

      db.collection("users").doc(uid).set({
        name: "",
        photo: "",
        email: emailOrPhone,
        id: newId
      }).then(() => {
        location.reload(); // Rehefa vita, mamerina ilay page
      });

      return;
    }

    const data = doc.data();

    if (data.name === "" || data.photo === "") {
      // Raha mbola tsy feno profil
      document.getElementById("profile-container").innerHTML = `
        <h3>Mamoròna profil</h3>
        <input id="name" placeholder="Anarana" />
        <input id="photo" placeholder="Lien sary (URL)" />
        <button onclick="saveProfile()">Enregistrer</button>
      `;
    } else {
      // Aseho profil raha efa feno
      document.getElementById("profile-container").innerHTML = `
        <img src="${data.photo}" width="100" style="border-radius: 50%" />
        <h2>${data.name}</h2>
        <p>ID manokana: <strong>${data.id}</strong></p>
        <p>Email: ${data.email || user.phoneNumber}</p>
      `;
    }
  });
});
function generateUniqueID() {
  return "PSFY-" + Math.floor(100000 + Math.random() * 900000);
}

