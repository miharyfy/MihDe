<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard - Profil</title>
  <style>
    /* Reset & body */
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1877f2, #6ea0f8);
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    /* Container */
    .container {
      background: white;
      width: 100%;
      max-width: 450px;
      padding: 30px 25px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(24, 119, 242, 0.4);
      text-align: center;
      animation: fadeIn 0.8s ease forwards;
    }
    /* Title */
    h2 {
      color: #1877f2;
      margin-bottom: 15px;
      font-weight: 700;
      letter-spacing: 1.2px;
    }
    /* Inputs */
    input, select {
      width: 100%;
      padding: 12px 15px;
      margin-top: 15px;
      border: 2px solid #cce0ff;
      border-radius: 15px;
      font-size: 16px;
      transition: border-color 0.3s ease;
      outline: none;
    }
    input:focus, select:focus {
      border-color: #1877f2;
      box-shadow: 0 0 8px #1877f2aa;
    }
    /* Buttons */
    button {
      margin-top: 25px;
      width: 100%;
      padding: 15px 0;
      font-size: 18px;
      border: none;
      border-radius: 18px;
      cursor: pointer;
      background: #1877f2;
      color: white;
      font-weight: 600;
      box-shadow: 0 5px 15px #1877f2cc;
      transition: background 0.3s ease, transform 0.15s ease;
    }
    button:hover {
      background: #145dbf;
      transform: scale(1.05);
    }
    /* Bouton PNG */
    #savePngBtn {
      margin-top: 15px;
      background: #28a745;
      box-shadow: 0 5px 15px #28a745cc;
    }
    #savePngBtn:hover {
      background: #218838;
    }
    /* Profile display */
    .profile-info {
      margin-top: 25px;
      text-align: left;
      font-size: 17px;
      color: #333;
      line-height: 1.4;
      border-top: 1px solid #cce0ff;
      padding-top: 20px;
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(24, 119, 242, 0.2);
    }
    .profile-info p {
      margin: 8px 0;
    }
    a.chat-link {
      display: inline-block;
      margin-top: 20px;
      background: #6ea0f8;
      color: white;
      padding: 10px 18px;
      border-radius: 15px;
      text-decoration: none;
      font-weight: 600;
      box-shadow: 0 4px 10px #6ea0f8cc;
      transition: background 0.3s ease;
    }
    a.chat-link:hover {
      background: #4f7de9;
    }
    /* Animation keyframes */
    @keyframes fadeIn {
      0% {opacity: 0; transform: translateY(25px);}
      100% {opacity: 1; transform: translateY(0);}
    }
    p.error {
      color: red;
      margin-top: 10px;
      font-weight: 600;
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- Ajout html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <div class="container" id="app">
    <h2>Profil Utilisateur</h2>
    <div id="profile-section">
      <!-- Formulaire ou profil affiché ici -->
    </div>
    <button id="logoutBtn">Sortir</button>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAzcnb-eswHt_pDi7tCvcIBzlzejCprJfE",
      authDomain: "mitalky.firebaseapp.com",
      projectId: "mitalky",
      storageBucket: "mitalky.appspot.com",
      messagingSenderId: "753557195623",
      appId: "1:753557195623:web:abc3b37eca5d67c9157dc2"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const VALID_REFERRAL_CODE = "REF123";

    auth.onAuthStateChanged(async user => {
      if (!user) return window.location.href = "login.html";

      const uid = user.uid;
      const profileSection = document.getElementById("profile-section");

      profileSection.innerHTML = `<p style="color:#1877f2">Chargement du profil...</p>`;

      try {
        const doc = await db.collection("users").doc(uid).get();

        if (!doc.exists) {
          profileSection.innerHTML = `
            <input id="name" type="text" placeholder="Nom complet" />
            <select id="genre">
              <option value="">Sélectionnez le genre</option>
              <option value="garçon">Garçon</option>
              <option value="fille">Fille</option>
              <option value="autre">Autre</option>
            </select>
            <input id="dob" type="date" placeholder="Date de naissance" />
            <input id="referral" type="text" placeholder="Code Referral" />
            <p class="error" id="formError"></p>
            <button id="saveBtn">Enregistrer Profil</button>
          `;
          document.getElementById("saveBtn").addEventListener('click', saveProfile);
        } else {
          const data = doc.data();
          showProfile(data, user, uid);
        }
      } catch (error) {
        profileSection.innerHTML = `<p style="color:red">Erreur de chargement: ${error.message}</p>`;
      }
    });

    function showProfile(data, user, uid) {
      const profileSection = document.getElementById("profile-section");
      profileSection.innerHTML = `
        <div class="profile-info" id="profileInfoToSave">
          <p><strong>Nom complet :</strong> ${data.name}</p>
          <p><strong>Genre :</strong> ${data.genre || '-'}</p>
          <p><strong>Date de naissance :</strong> ${data.dob || '-'}</p>
          <p><strong>Code Referral :</strong> ${data.referral || '-'}</p>
          <p><strong>ID :</strong> ${data.id}</p>
          <p><strong>Email :</strong> ${data.email || user.phoneNumber}</p>
        </div>
        <a class="chat-link" href="chat.html?uid=${uid}">Aller au chat</a>
        <button id="savePngBtn">Enregistrer profil en PNG</button>
      `;

      document.getElementById("savePngBtn").addEventListener("click", saveProfileAsPng);
    }

    async function saveProfile() {
      const uid = auth.currentUser.uid;
      const name = document.getElementById("name").value.trim();
      const genre = document.getElementById("genre").value;
      const dob = document.getElementById("dob").value;
      const referral = document.getElementById("referral").value.trim();
      const formError = document.getElementById("formError");

      formError.textContent = "";

      if (!name || !genre || !dob || !referral) {
        formError.textContent = "Veuillez remplir tous les champs.";
        return;
      }

      if (!isAtLeast16YearsOld(dob)) {
        formError.textContent = "Vous devez avoir au moins 16 ans.";
        return;
      }

      if (referral !== VALID_REFERRAL_CODE) {
        formError.textContent = "Code Referral invalide.";
        return;
      }

      const id = Math.floor(100000 + Math.random() * 900000);
      const email = auth.currentUser.email || auth.currentUser.phoneNumber;

      try {
        await db.collection("users").doc(uid).set({
          name,
          genre,
          dob,
          referral,
          id,
          email
        });
        alert("Profil enregistré !");
        const doc = await db.collection("users").doc(uid).get();
        showProfile(doc.data(), auth.currentUser, uid);
      } catch (e) {
        alert("Erreur: " + e.message);
      }
    }

    function isAtLeast16YearsOld(dob) {
      if (!dob) return false;
      const today = new Date();
      const birthDate = new Date(dob);
      let age = today.getFullYear() - birthDate.getFullYear();
      const m = today.getMonth() - birthDate.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
        age--;
      }
      return age >= 16;
    }

    function saveProfileAsPng() {
      const profileDiv = document.getElementById("profileInfoToSave");
      if (!profileDiv) return alert("Profil introuvable.");

      html2canvas(profileDiv).then(canvas => {
        canvas.toBlob(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "profil_utilisateur.png";
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        });
      }).catch(err => {
        alert("Erreur lors de la création du PNG: " + err);
      });
    }

    document.getElementById("logoutBtn").addEventListener("click", () => {
      auth.signOut().then(() => {
        alert("Vous êtes déconnecté.");
        window.location.href = "login.html";
      }).catch(err => {
        alert("Erreur lors de la déconnexion: " + err.message);
      });
    });
  </script>
</body>
</html>
