<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard - Profil</title>
  <style>
    /* ... (style tsy ovaina eto) ... */
    /* Add margin to the new button */
    #savePngBtn {
      margin-top: 15px;
      background: #28a745;
      box-shadow: 0 5px 15px #28a745cc;
    }
    #savePngBtn:hover {
      background: #218838;
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- Ajout html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <div class="container" id="app">
    <h2>Profil Utilisateur</h2>
    <div id="profile-section">
      <!-- Formulaire ou profil affiché ici -->
    </div>
    <button id="logoutBtn">Sortir</button>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAzcnb-eswHt_pDi7tCvcIBzlzejCprJfE",
      authDomain: "mitalky.firebaseapp.com",
      projectId: "mitalky",
      storageBucket: "mitalky.appspot.com",
      messagingSenderId: "753557195623",
      appId: "1:753557195623:web:abc3b37eca5d67c9157dc2"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const VALID_REFERRAL_CODE = "REF123";

    auth.onAuthStateChanged(async user => {
      if (!user) return window.location.href = "login.html";

      const uid = user.uid;
      const profileSection = document.getElementById("profile-section");

      profileSection.innerHTML = `<p style="color:#1877f2">Chargement du profil...</p>`;

      try {
        const doc = await db.collection("users").doc(uid).get();

        if (!doc.exists) {
          profileSection.innerHTML = `
            <input id="name" type="text" placeholder="Nom complet" />
            <select id="genre">
              <option value="">Sélectionnez le genre</option>
              <option value="garçon">Garçon</option>
              <option value="fille">Fille</option>
              <option value="autre">Autre</option>
            </select>
            <input id="dob" type="date" placeholder="Date de naissance" />
            <input id="referral" type="text" placeholder="Code Referral" />
            <p class="error" id="formError"></p>
            <button id="saveBtn">Enregistrer Profil</button>
          `;
          document.getElementById("saveBtn").addEventListener('click', saveProfile);
        } else {
          const data = doc.data();
          showProfile(data, user, uid);
        }
      } catch (error) {
        profileSection.innerHTML = `<p style="color:red">Erreur de chargement: ${error.message}</p>`;
      }
    });

    function showProfile(data, user, uid) {
      const profileSection = document.getElementById("profile-section");
      profileSection.innerHTML = `
        <div class="profile-info" id="profileInfoToSave">
          <p><strong>Nom complet :</strong> ${data.name}</p>
          <p><strong>Genre :</strong> ${data.genre || '-'}</p>
          <p><strong>Date de naissance :</strong> ${data.dob || '-'}</p>
          <p><strong>Code Referral :</strong> ${data.referral || '-'}</p>
          <p><strong>ID :</strong> ${data.id}</p>
          <p><strong>Email :</strong> ${data.email || user.phoneNumber}</p>
        </div>
        <a class="chat-link" href="chat.html?uid=${uid}">Aller au chat</a>
        <button id="savePngBtn">Enregistrer profil en PNG</button>
      `;

      document.getElementById("savePngBtn").addEventListener("click", saveProfileAsPng);
    }

    async function saveProfile() {
      const uid = auth.currentUser.uid;
      const name = document.getElementById("name").value.trim();
      const genre = document.getElementById("genre").value;
      const dob = document.getElementById("dob").value;
      const referral = document.getElementById("referral").value.trim();
      const formError = document.getElementById("formError");

      formError.textContent = "";

      if (!name || !genre || !dob || !referral) {
        formError.textContent = "Veuillez remplir tous les champs.";
        return;
      }

      if (!isAtLeast16YearsOld(dob)) {
        formError.textContent = "Vous devez avoir au moins 16 ans.";
        return;
      }

      if (referral !== VALID_REFERRAL_CODE) {
        formError.textContent = "Code Referral invalide.";
        return;
      }

      const id = Math.floor(100000 + Math.random() * 900000);
      const email = auth.currentUser.email || auth.currentUser.phoneNumber;

      try {
        await db.collection("users").doc(uid).set({
          name,
          genre,
          dob,
          referral,
          id,
          email
        });
        alert("Profil enregistré !");
        const doc = await db.collection("users").doc(uid).get();
        showProfile(doc.data(), auth.currentUser, uid);
      } catch (e) {
        alert("Erreur: " + e.message);
      }
    }

    function isAtLeast16YearsOld(dob) {
      if (!dob) return false;
      const today = new Date();
      const birthDate = new Date(dob);
      let age = today.getFullYear() - birthDate.getFullYear();
      const m = today.getMonth() - birthDate.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
        age--;
      }
      return age >= 16;
    }

    function saveProfileAsPng() {
      const profileDiv = document.getElementById("profileInfoToSave");
      if (!profileDiv) return alert("Profil introuvable.");

      // Utiliser html2canvas pour créer l'image
      html2canvas(profileDiv).then(canvas => {
        // Transformer canvas en image PNG
        canvas.toBlob(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "profil_utilisateur.png";
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        });
      }).catch(err => {
        alert("Erreur lors de la création du PNG: " + err);
      });
    }

    document.getElementById("logoutBtn").addEventListener("click", () => {
      auth.signOut().then(() => {
        alert("Vous êtes déconnecté.");
        window.location.href = "login.html";
      }).catch(err => {
        alert("Erreur lors de la déconnexion: " + err.message);
      });
    });
  </script>
</body>
</html>
