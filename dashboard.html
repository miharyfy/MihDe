<!DOCTYPE html>
<html lang="mg">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Mi-talky</title>
  <style>
    body { font-family: Arial; background:#f0f2f5; padding:20px; }
    #profile-container { background: white; padding: 20px; border-radius: 10px; max-width: 400px; margin: auto; }
    #photo-preview { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; }
    input, select, button { width: 100%; margin: 10px 0; padding: 10px; border-radius: 8px; border: 1px solid #ccc; }
    button { background: #1877f2; color: white; border:none; cursor:pointer; }
  </style>
</head>
<body>

<div id="profile-container">
  <h2>Profilanao</h2>
  <img id="photo-preview" src="https://i.imgur.com/5qHPeIp.png" alt="Profile photo" />
  <input type="file" id="photo-upload" accept="image/*" />
  <input type="text" id="name" placeholder="Anarana" />
  <select id="gender">
    <option value="">Misafidiana Genre</option>
    <option value="Fille">Fille</option>
    <option value="Garçon">Garçon</option>
    <option value="Autre">Tsy Aiko</option>
  </select>
  <button id="save-btn">Tehirizo</button>
  <button id="logoutBtn" style="background:#e74c3c; margin-top:10px;">Hivoaka</button>
  <p id="status"></p>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAzcnb-eswHt_pDi7tCvcIBzlzejCprJfE",
    authDomain: "mitalky.firebaseapp.com",
    projectId: "mitalky",
    storageBucket: "mitalky.appspot.com",
    messagingSenderId: "753557195623",
    appId: "1:753557195623:web:abc3b37eca5d67c9157dc2"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  let currentUser = null;
  let photoFile = null;

  const photoPreview = document.getElementById("photo-preview");
  const photoUpload = document.getElementById("photo-upload");
  const nameInput = document.getElementById("name");
  const genderSelect = document.getElementById("gender");
  const saveBtn = document.getElementById("save-btn");
  const logoutBtn = document.getElementById("logoutBtn");
  const statusP = document.getElementById("status");

  auth.onAuthStateChanged(user => {
    if (!user) {
      window.location.href = "nextpage.html";
      return;
    }
    currentUser = user;
    loadProfile();
  });

  photoUpload.addEventListener("change", e => {
    if (e.target.files && e.target.files[0]) {
      photoFile = e.target.files[0];
      const reader = new FileReader();
      reader.onload = evt => {
        photoPreview.src = evt.target.result;
      };
      reader.readAsDataURL(photoFile);
    }
  });

  function loadProfile() {
    db.collection("users").doc(currentUser.uid).get()
      .then(doc => {
        if (doc.exists) {
          const data = doc.data();
          if (data.photo) photoPreview.src = data.photo;
          if (data.name) nameInput.value = data.name;
          if (data.gender) genderSelect.value = data.gender;
          statusP.textContent = "";
        } else {
          statusP.textContent = "Profil tsy mbola misy, fenoy azafady.";
        }
      })
      .catch(err => {
        statusP.textContent = "Nisy olana tamin'ny famakiana profil: " + err.message;
      });
  }

  saveBtn.addEventListener("click", async () => {
    const name = nameInput.value.trim();
    const gender = genderSelect.value;
    if (!name || !gender) {
      alert("Fenoy azafady ny anarana sy ny genre.");
      return;
    }
    statusP.textContent = "Mitahiry profil...";
    let photoURL = photoPreview.src;
    if (photoFile) {
      try {
        const ref = storage.ref(`profile_photos/${currentUser.uid}_${Date.now()}`);
        await ref.put(photoFile);
        photoURL = await ref.getDownloadURL();
      } catch (err) {
        alert("Nisy olana tamin'ny upload sary: " + err.message);
        statusP.textContent = "";
        return;
      }
    }
    db.collection("users").doc(currentUser.uid).set({
      name: name,
      gender: gender,
      photo: photoURL,
      email: currentUser.email || currentUser.phoneNumber || "",
      id: generateUniqueID()
    }, {merge:true})
    .then(() => {
      statusP.textContent = "Profil voatahiry tsara!";
      photoFile = null;
      loadProfile();
    })
    .catch(err => {
      alert("Nisy olana tamin'ny fanoratana profil: " + err.message);
      statusP.textContent = "";
    });
  });

  logoutBtn.addEventListener("click", () => {
    auth.signOut().then(() => {
      window.location.href = "nextpage.html";
    });
  });

  function generateUniqueID() {
    return Math.floor(100000 + Math.random() * 900000);
  }
</script>

</body>
</html>
